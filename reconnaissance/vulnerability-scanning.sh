#!/bin/bash
# Gather Vulnerability Information

####################
# Global variables #
####################

DEPENDENCIES="git nmap nikto"
myVULNFILE="output/vuln-findings.txt"

#############
# Functions #
#############

function fuNmapVulnScan {
  fuTITLE "Nmap vulnerability scan with vuln script of $1 and port $2 ..."
  nmap -Pn -sV --script vuln $1 -p $2 -oN $myVULNFILE
}

function fuNmapVulnersScan {
  # https://github.com/vulnersCom/nmap-vulners
  # fuMESSAGE "Cloning nmap-vulners script ..."
  # git clone -q https://github.com/vulnersCom/nmap-vulners.git /usr/share/nmap/scripts/nmap-vulners/
  # nmap --script-updatedb
  # Note that it is already included into the standard nmap NSE library.
  # it only works with -sV flag.
  fuTITLE "Nmap vulnerability scan with vulners script of $1 and port $2 ..."
  nmap -Pn -sV --script vulners $1 -p $2 -oN $myVULNFILE
}

function fuNiktoScan {
  fuTITLE "Scanning webserver vulnerabilities of $1 ..."
  nikto -h $1 -port $2 $3 -o $myVULNFILE
}

################################
# Installation of Dependencies #
################################

fuGET_DEPS

##########################
# Vulnerability Scanning #
##########################

# nmap 
# vuln + nmap-vulners

if [ "$IP" != "" ] && [ "$TCPPORT" != "" ] && [ "$UDPPORT" != "" ]; then
  fuNmapVulnersScan $IP $TCPPORT,$UDPPORT

elif [ "$IP" != "" ] && [ "$TCPPORT" != "" ] && [ "$UDPPORT" == "" ]; then
  fuNmapVulnersScan $IP $TCPPORT

elif [ "$IP" != "" ] && [ "$TCPPORT" == "" ] && [ "$UDPPORT" != "" ]; then
  fuNmapVulnersScan $IP $UDPPORT

elif [ "$IP" != "" ] && [ "$TCPPORT" == "" ] && [ "$UDPPORT" == "" ] && [ -s targetPort.txt ]; then
  # change newlines to comma separated
  fuNmapVulnersScan $IP $(tr '\n' , <targetPort.txt)

fi


# nikto
# if ports 80 and 433 open...
if [ "$IP" != "" ] && ( grep -q -w 443 "targetPort.txt" || [ "$TCPPORT" == "443" ] ); then
  fuNiktoScan $IP 443 -ssl
  
elif [ "$DOMAIN" != "" ] && ( grep -q -w 443 "targetPort.txt" || [ "$TCPPORT" == "443" ] ); then
  fuNiktoScan $DOMAIN 443 -ssl

elif [ "$IP" != "" ] && ( grep -q -w 80 "targetPort.txt" || [ "$TCPPORT" == "80" ] ); then
  fuNiktoScan $IP 80
  
elif [ "$DOMAIN" != "" ] && ( grep -q -w 80 "targetPort.txt" || [ "$TCPPORT" == "80" ] ); then
  fuNiktoScan $DOMAIN 80

fi


# WMAP
# https://www.offensive-security.com/metasploit-unleashed/wmap-web-scanner/

#Â ATSCAN
# https://www.geeksforgeeks.org/atscan-advance-web-application-scanner-in-kali-linux/


#####################
# Summarize results #
#####################

fuTITLE "Findings in following files:"
if [ -s "$myVULNFILE" ]; then
  echo "Vulnerabilities found in: $myVULNFILE"
fi
